---
import { getToolRoutes } from '@/registry/tools'
import { translateMeta, supportedLanguages } from '@/i18n/utils'
import type { SupportedLanguage } from '@/i18n/utils'
import ToolLayout from '@/layouts/ToolLayout.astro'
import type { ToolRoute } from '@/types/tool'

export async function getStaticPaths() {
  const routes = await getToolRoutes()
  // Exclude English (English uses default route)
  const languages = supportedLanguages.filter(lang => lang !== 'en')

  return routes.flatMap(route =>
    languages.flatMap(lang => {
      // Main route
      const paths: Array<{ params: { lang: string; path: string }; props: { route: ToolRoute; lang: SupportedLanguage; subPath: string | undefined } }> = [{
        params: { lang, path: route.id },
        props: { route, lang, subPath: undefined }
      }]

      // Sub-routes
      if (route.tool.subPaths) {
        route.tool.subPaths.forEach(sub => {
          paths.push({
            params: { lang, path: `${route.id}/${sub}` },
            props: { route, lang, subPath: sub as string }
          })
        })
      }

      return paths
    })
  )
}

const { route, lang, subPath } = Astro.props as { route: ToolRoute; lang: SupportedLanguage; subPath: string | undefined }
const metadata = translateMeta(route.tool, lang)

// Dynamic import component (Vue or Astro)
const componentPath = subPath
  ? `/src/tools/${route.tool.domain}/${route.tool.id}/${subPath}.astro`
  : `/src/tools/${route.tool.domain}/${route.tool.id}/index.astro`

let Component
try {
  const module = await import(/* @vite-ignore */ componentPath)
  Component = module.default
} catch (e) {
  // Component not found, show placeholder
  Component = null
}
---

<ToolLayout title={metadata.name} description={metadata.description} lang={lang}>
  {Component ? (
    route.tool.type === 'vue-island' ? (
      <Component client:load ui={metadata.ui} />
    ) : (
      <Component ui={metadata.ui} />
    )
  ) : (
    <div class="tool-placeholder">
      <h2>Tool: {route.id}</h2>
      <p>This tool is not yet implemented.</p>
      <p>Component path: {componentPath}</p>
    </div>
  )}
</ToolLayout>

<style>
  .tool-placeholder {
    padding: 2rem;
    background: #f5f5f5;
    border-radius: 8px;
    text-align: center;
  }
</style>
